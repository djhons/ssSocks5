name: Build and Release

on:
  # 1. 保留标签触发：当你推送 tag (如 v1.0.0) 时自动运行
  push:
    tags:
      - 'v2.0.0'
  # 2. 新增手动触发：在网页 Actions 页面点击 "Run workflow" 按钮
  workflow_dispatch:
    inputs:
      tag_name:
        description: '版本号 (例如 v1.1.0)'
        required: true
        default: 'test-build'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          - goos: windows
            goarch: arm64

    steps:
      - name: Checkout codebase
        uses: actions/checkout@v4

      # 1. 构建并发布 Server 端
      - name: Build and Release Server
        uses: wangyoucao577/go-release-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          goos: ${{ matrix.goos }}
          goarch: ${{ matrix.goarch }}
          go_version: "1.21"
          project_path: "./server"
          binary_name: "server"
          
          # 关键逻辑：如果是手动触发，使用输入的 tag；如果是 tag 触发，插件会自动识别
          release_tag: ${{ inputs.tag_name }}
          
          # 保持 CGO_ENABLED=0 以兼容 CentOS 7
          env: |
            CGO_ENABLED=0
            
          extra_files: "README.md"
          asset_name: "server-${{ matrix.goos }}-${{ matrix.goarch }}"
          compress_assets: true
          overwrite: true

      # 2. 构建并发布 Client 端
      - name: Build and Release Client
        uses: wangyoucao577/go-release-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          goos: ${{ matrix.goos }}
          goarch: ${{ matrix.goarch }}
          go_version: "1.21"
          project_path: "./client"
          binary_name: "client"
          
          # 同样应用手动输入的 tag
          release_tag: ${{ inputs.tag_name }}
          
          env: |
            CGO_ENABLED=0
            
          extra_files: "README.md"
          asset_name: "client-${{ matrix.goos }}-${{ matrix.goarch }}"
          compress_assets: true
          overwrite: true
